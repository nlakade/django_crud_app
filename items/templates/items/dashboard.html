{% extends 'items/base.html' %}

{% block title %}Dashboard - Data Visualization{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">üìä Dashboard & Data Visualization</h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Total Items</h5>
                <h2>{{ total_items }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Total Value</h5>
                <h2>${{ total_value|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">Average Price</h5>
                <h2>${{ avg_price|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Chart 1: Items by Category -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>üìà Items by Category</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart 2: Daily Items Added (Last 7 Days) -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>üìÖ Daily Items Added (Last 7 Days)</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Third-party API Integration -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>üå§Ô∏è Third-party API Integration: Weather Data</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" id="cityInput" class="form-control" placeholder="Enter city name" value="London">
                </div>
                <button onclick="fetchWeather()" class="btn btn-primary">Get Weather</button>
                <div id="weatherResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- API Testing Section -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>üîß API Testing</h5>
            </div>
            <div class="card-body">
                <p>Test the REST APIs:</p>
                <ul>
                    <li><a href="/api/items/" target="_blank">GET /api/items/</a> - List all items</li>
                    <li><a href="/api/items/categories/" target="_blank">GET /api/items/categories/</a> - Category statistics</li>
                    <li><a href="/api/weather/?city=London" target="_blank">GET /api/weather/?city=London</a> - Weather API</li>
                </ul>
                <p>Use tools like Postman or curl to test POST, PUT, DELETE operations.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Chart 1: Items by Category
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryChart = new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: {{ categories|safe }},
            datasets: [{
                label: 'Number of Items',
                data: {{ category_counts|safe }},
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Chart 2: Daily Items Added
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    const dailyChart = new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: {{ dates|safe }},
            datasets: [{
                label: 'Items Added',
                data: {{ daily_counts|safe }},
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Weather API Function
    function fetchWeather() {
        const city = document.getElementById('cityInput').value;
        const resultDiv = document.getElementById('weatherResult');
        
        resultDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
        
        fetch(`/api/weather/?city=${encodeURIComponent(city)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5>Weather in ${data.city}</h5>
                                <p><strong>Temperature:</strong> ${data.temperature}¬∞C</p>
                                <p><strong>Description:</strong> ${data.description}</p>
                                <p><strong>Humidity:</strong> ${data.humidity}%</p>
                                <p><strong>Wind Speed:</strong> ${data.wind_speed} m/s</p>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error fetching weather data: ${error}</div>`;
            });
    }
</script>
{% endblock %}